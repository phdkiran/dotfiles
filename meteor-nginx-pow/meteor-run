#!/usr/bin/env bash

if [[ ! -z "$1" ]]; then
  ROOT=$1
  NAME=$2
else
  echo 'Usage: meteor-run root name port [settings] [ssl]'
  echo '       meteor-run ./app leaderboard 3000 ../config/settings.json ssl'
  exit
fi

if [ ! -z $3 ]; then
  PORT=$3
  PORT_ARG="--port $3"
fi

if [ ! -z $4 ]; then
  SETTINGS_ARG="--settings $4"
fi

if [ ! -z $5 ]; then
  PROTOCOL='https'
else
  PROTOCOL='http'
fi

IP=`ifconfig | grep -Eo 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -Eo '([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -n 1`
ROOT_URL=${PROTOCOL}://${NAME}.${IP}.xip.io

cd $ROOT
if [ ! $? -eq 0 ]; then exit; fi
echo $PORT > ~/.pow/$NAME

cat > /usr/local/etc/nginx/sites-enabled/${NAME}.dev <<EOL
server {
  listen 443 ssl;
  server_name ${NAME}.${IP}.xip.io;

  root ${ROOT};
  index index.html;

  ### SSL cert files ###
  ssl_certificate /usr/local/etc/nginx/ssl/xip.io.crt;
  ssl_certificate_key /usr/local/etc/nginx/ssl/xip.io.key;

  location / {
    proxy_set_header Host \$host;
    proxy_set_header X-Real-IP \$remote_addr;
    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    proxy_redirect off;
    proxy_pass http://localhost:20559;
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
    proxy_set_header X-Forwarded-Proto https;
  }
}
server {
  listen 443 ssl;
  server_name  *.xip.io;
  server_name ${NAME}.dev;

  root ${ROOT};
  index index.html;

  ### SSL cert files ###
  ssl_certificate /usr/local/etc/nginx/ssl/dev.crt;
  ssl_certificate_key /usr/local/etc/nginx/ssl/dev.key;

  location / {
    proxy_set_header Host \$host;
    proxy_set_header X-Real-IP \$remote_addr;
    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    proxy_redirect off;
    proxy_pass http://localhost:20559;
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
    proxy_set_header X-Forwarded-Proto https;
  }
}
EOL

DISABLE_WEBSOCKETS=1 ROOT_URL=${ROOT_URL} meteor ${PORT_ARG} ${SETTINGS_ARG}
